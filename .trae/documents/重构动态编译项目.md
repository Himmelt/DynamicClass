# 重构动态编译项目计划

## 1. 项目结构转换

### 1.1 将应用程序转换为库项目

* 修改 `DynamicClass.csproj`，将 `<OutputType>` 从 `Exe` 改为 `Library`

* 移除 `Program.cs` 中的主方法，保留测试代码用于迁移

### 1.2 创建单元测试项目

* 创建 `DynamicClass.Tests` 测试项目（.NET 9）

* 安装必要的测试依赖（如 xUnit、Moq 等）

* 迁移 `Program.cs` 中的测试用例到测试项目

* 添加全面的单元测试，覆盖所有功能

## 2. 模块化架构设计

### 2.1 分解 DynamicCompiler 类

将当前的 `DynamicCompiler` 类分解为以下模块：

| 模块名称                | 责任           | 文件位置                        |
| ------------------- | ------------ | --------------------------- |
| `CodeAnalyzer`      | 代码分析和程序集引用检测 | `Core/CodeAnalyzer.cs`      |
| `Compiler`          | 动态编译核心逻辑     | `Core/Compiler.cs`          |
| `DelegateConverter` | 方法到委托的转换     | `Core/DelegateConverter.cs` |
| `MethodValidator`   | 方法验证和类型检查    | `Core/MethodValidator.cs`   |
| `DynamicCompiler`   | 对外统一接口（门面模式） | `Core/DynamicCompiler.cs`   |

### 2.2 数据模型分离

将所有结果类和数据模型分离到单独的命名空间：

* `Models/CompilationResult.cs`

* `Models/ValidationResult.cs`

* `Models/MethodValidationResult.cs`

* `Models/AssemblyDetectionRule.cs`

## 3. 功能扩展和优化

### 3.1 支持从文本文件编译

* 添加 `CompileFromFile(string filePath)` 方法

* 确保与现有 `CompileCode(string code)` 方法保持一致的返回类型和错误处理

* 实现文件读取和内容验证

### 3.2 优化编译接口

* 标准化方法签名

* 改进错误处理，提供更详细的错误信息

* 添加日志记录支持

* 优化性能，特别是在程序集引用检测方面

### 3.3 保持向后兼容性

* 确保现有方法签名和行为不变

* 新功能通过重载方法或可选参数实现

* 提供明确的升级路径

## 4. 实现步骤

### 第1步：创建项目结构

* 修改主项目为库项目

* 创建测试项目

* 创建模块化目录结构

### 第2步：迁移现有功能

* 将现有功能分解到各个模块

* 确保功能完整性

* 运行现有测试验证

### 第3步：实现新功能

* 添加从文件编译的功能

* 优化错误处理

### 第4步：编写单元测试

* 为每个模块编写单元测试

* 覆盖各种边界情况

### 第5步：优化和文档

* 优化性能

* 添加详细的XML文档注释

* 编写使用示例

## 5. 预期结果

* 项目从控制台应用程序转换为可重用的库

* 模块化架构，各组件职责清晰

* 支持从字符串和文件编译代码

* 改进的错误处理

* 全面的单元测试覆盖

## 6. 技术栈

* .NET 9

* Microsoft.CodeAnalysis.CSharp.Scripting 5.0.0

* xUnit（测试）

* Moq（模拟）

## 7. 文件结构

```
DynamicClass/
├── DynamicClass.csproj          # 主库项目
├── Core/                        # 核心功能模块
│   ├── DynamicCompiler.cs       # 对外统一接口
│   ├── CodeAnalyzer.cs          # 代码分析器
│   ├── Compiler.cs              # 编译器
│   ├── DelegateConverter.cs     # 委托转换器
│   └── MethodValidator.cs       # 方法验证器
├── Models/                      # 数据模型
│   ├── CompilationResult.cs     # 编译结果
│   ├── ValidationResult.cs      # 验证结果
│   ├── MethodValidationResult.cs# 方法验证结果
│   └── AssemblyDetectionRule.cs # 程序集检测规则
└── DynamicClass.Tests/          # 测试项目
    ├── DynamicClass.Tests.csproj
    ├── Core/                    # 核心功能测试
    └── Models/                  # 模型测试
```

